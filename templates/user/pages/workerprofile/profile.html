{% extends 'user/pages/workerprofile/base.html' %}
{% load static %}
{% block page %}

    <div class="tab-pane fade show active"
         id="account"
         role="tabpanel"
         aria-labelledby="account-tab">
        <form id="update-form"
              method="post"
              action="{% url 'updateworkerprofile' user.profile.pk %}">
            {% csrf_token %}
            <h3 class="mb-4">Worker Account Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text"
                               class="form-control"
                               name="first_name"
                               id="firstname-field"
                               value="{{ user.first_name }}"
                               readonly/>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text"
                               class="form-control"
                               name="last_name"
                               id="lastname-field"
                               value="{{ user.last_name }}"
                               readonly/>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Gender</label>
                        <select class="form-control" name="gender" id="gender-field">
                            <option value="male"
                                    {% if user.profile.gender == 'male' %} selected{% endif %}>
                            male
                            </option>
                            <option value="female"
                                    {% if user.profile.gender == 'female' %} selected{% endif %}>
                            female
                            </option>
                        </select>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text"
                               class="form-control"
                               name="email"
                               id="email-field"
                               value="{{ user.email }}"/>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Phone number</label>
                        <input type="text"
                               class="form-control"
                               name="phone_number"
                               id="mobile-number"
                               value="{{ user.profile.phone_number }}"/>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Complete address</label>
                        <input type="text"
                               class="form-control"
                               name="location"
                               id="location-field"
                               value="{{ user.profile.location }}"/>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Charge per hour</label>
                        <input type="text"
                               class="form-control"
                               id="charge-field"
                               name="fee"
                               value="{{ user.profile.fee }}"/>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Years of experience</label>
                        <input type="text"
                               class="form-control"
                               name="experience"
                               id="experience-field"
                               value="{{ user.profile.experience }}"/>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Service providing</label>
                        <select class="form-control" id="service-field" name="service">
                            {% for service in services %}
                            {{ service }}
                            <option value="{{ service.id }}"
                                    {% if service.id == user.profile.service.id %} selected{% endif %}>
                                {{ service }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Skills</label>
                        <select class="form-control multiple-skills"
                                id="skill-field"
                                name="skill"
                                multiple="multiple"
                                tabindex="0">
                            {% for skill in skills %}
                            <option value="{{ skill.id }}"
                                    {% if skill in user.profile.skill.all %} selected{% endif %}>
                                {{ skill.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea class="form-control" name="bio" id="detail-field"
                                  rows="4">{{user.profile.bio}}</textarea>
                        <div class="error"></div>
                    </div>
                </div>
            </div>
            <div>
                <button type="submit" class="btn btn-primary update-button">Update</button>
                <a href="#" class="btn btn-light">Cancel</a>
            </div>
        </form>
    </div>

    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'lib/select2/js/select2.min.js' %}"></script>
    <script type="text/javascript">
	$(document).ready(function() {
    	$('.multiple-skills').select2();

	});


    </script>
    <script type="text/javascript">

	$('.update-button').on('click', function(e){
       	e.preventDefault();
       	if(validateInputs()){
           	$('#update-form').submit();
       	}
   	})


	const isValidEmail = email => {
        const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(String(email).toLowerCase());
    }

    const isValidMobile = (contact) =>{
        const re = /(\+977)?[9][6-9]\d{8}/;
        return re.test(contact);

    }

	const setError = (element , message) => {
        const inputControl = element.parentElement;
        const errorDisplay = inputControl.querySelector('.error');
        errorDisplay.innerText = message;
        inputControl.classList.add('error');
        inputControl.classList.remove('success');

    }
    const setSuccess = (element) => {
        const inputControl = element.parentElement;
        const errorDisplay = inputControl.querySelector('.error');
        errorDisplay.innerText = " ";
        inputControl.classList.add('success');
        inputControl.classList.remove('error');

    }
    const validateInputs = () => {
    	console.log("errorrerere");
    	const email = document.getElementById('email-field');
   		const bio = document.getElementById('detail-field');
   		const address = document.getElementById('location-field');
   		const contact = document.getElementById('mobile-number');
   		const gender = document.getElementById('gender-field');
   		const fee = document.getElementById('charge-field');
   		const experience = document.getElementById('experience-field');
        var is_form_valid = true;
        const emailValue = email.value.trim();
        const bioValue = bio.value.trim();
        const addressValue = address.value.trim();
        const contactValue = contact.value.trim();
        const genderValue = gender.value.trim();
        const feeValue = fee.value.trim();
        const experienceValue = experience.value.trim();


        if(emailValue === ''){
            setError(email, 'Email is required');
            is_form_valid = false;
        }
        else if(!isValidEmail(emailValue)){
            setError(email, 'Invalid email');
            is_form_valid = false;
        }
        else{
            setSuccess(email);
        }

        if(bioValue == ''){
            setError(bio , 'Bio field is required');
            is_form_valid = false;
        }
        else{
            setSuccess(bio)
        }

        if(addressValue == ''){
            setError(address , 'Location field is required');
            is_form_valid = false;
        }
        else{
            setSuccess(address);
        }

        if(contactValue == ''){
            setError(contact , 'Mobile number field is required');
            is_form_valid = false;
        }
        else if( !isValidMobile(contactValue)){
            setError(contact , 'Invalid mobile number');
            is_form_valid = false;
        }
        else{
            setSuccess(contact);
        }

        if(genderValue == ''){
            setError(gender, 'Service value is required');
            is_form_valid = false;
        }
        else{
            setSuccess(gender);
        }


        if(feeValue == ''){
            setError(fee, 'fee is required');
            is_form_valid = false;
        }
        else if(feeValue <=0){
            setError(fee, 'charge should be greater than 0');
            is_form_valid = false;
        }
        else{
            setSuccess(fee);
        }

        if(experienceValue == ''){
            setError(experience, 'experience is required');
            is_form_valid = false;
        }
        else if(feeValue <0){
            setError(experience, 'Experience should be 0 years or more');
            is_form_valid = false;
        }
        else{
            setSuccess(experience);
        }

        return is_form_valid;

    }



    </script>
    {% endblock %}